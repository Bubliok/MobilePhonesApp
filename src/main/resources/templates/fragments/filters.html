<div class="product-filters" th:fragment="filters">
    <aside class="filter-sidebar p-3 bg-light rounded">
        <h5 class="mb-3">Filters</h5>

        <div class="active-filters mb-4"
             th:if="${param.brands != null || param.storages != null || param.colors != null || param.ram != null || param.maxPrice != null || param.screenSizes != null || param.waterResistant != null || param.batteryCapacities != null || param.discountedOnly != null}">
            <h6 class="mb-3">Active Filters:

                <a th:if="${param.brands != null || param.storages != null || param.colors != null || param.ram != null || param.maxPrice != null || param.screenSizes != null || param.waterResistant != null || param.batteryCapacities != null || param.discountedOnly != null}"
                   th:href="@{/phones}"
                   class="btn btn-outline-danger btn-sm ms-2">Clear All</a>
            </h6>
            <div>
                <span th:each="brand : ${param.brands}" class="filter-tag">
                    <span th:text="${brand}"></span>
                    <a th:with="remainingBrands=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.brands, ',').replace(brand + ',', '').replace(',' + brand, '').replace(brand, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${!#strings.isEmpty(remainingBrands) ? remainingBrands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null}, 
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null}, 
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:each="storage : ${param.storages}" class="filter-tag">
                    <span th:text="${storage + ' GB'}"></span>
                    <a th:with="remainingStorages=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.storages, ',').replace(storage + ',', '').replace(',' + storage, '').replace(storage, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${!#strings.isEmpty(remainingStorages) ? remainingStorages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null}, 
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:each="color : ${param.colors}" class="filter-tag">
                    <span th:text="${color}"></span>
                    <a th:with="remainingColors=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.colors, ',').replace(color + ',', '').replace(',' + color, '').replace(color, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${!#strings.isEmpty(remainingColors) ? remainingColors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:each="ram : ${param.ram}" class="filter-tag">
                    <span th:text="${ram + ' GB'}"></span>
                    <a th:with="remainingRam=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.ram, ',').replace(ram + ',', '').replace(',' + ram, '').replace(ram, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${!#strings.isEmpty(remainingRam) ? remainingRam : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:if="${param.maxPrice != null && param.maxPrice[0] != '3000'}" class="filter-tag">
                    Max Price: <span th:text=" ${param.maxPrice[0] + ' лв.'}"></span>
                    <a th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:each="screenSize : ${param.screenSizes}" class="filter-tag">
                    Screen: <span th:text="${screenSize + ' inches'}"></span>
                    <a th:with="remainingScreenSizes=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.screenSizes, ',').replace(screenSize + ',', '').replace(',' + screenSize, '').replace(screenSize, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           screenSizes=${!#strings.isEmpty(remainingScreenSizes) ? remainingScreenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:if="${param.waterResistant != null && param.waterResistant[0] == 'true'}" class="filter-tag">
                    <span>Water Resistant</span>
                    <a th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:each="capacity : ${param.batteryCapacities}" class="filter-tag">
                    Battery: <span th:text="${capacity + ' mAh'}"></span>
                    <a th:with="remainingCapacities=${#strings.listJoin(#strings.arraySplit(#strings.arrayJoin(param.batteryCapacities, ',').replace(capacity + ',', '').replace(',' + capacity, '').replace(capacity, ''), ','), ',')}"
                       th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${!#strings.isEmpty(remainingCapacities) ? remainingCapacities : null},
                           discountedOnly=${param.discountedOnly != null ? param.discountedOnly[0] : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>

                <span th:if="${param.discountedOnly != null && param.discountedOnly[0] == 'true'}" class="filter-tag">
                    <span>On Sale Only</span>
                    <a th:href="@{/phones(
                           brands=${param.brands != null and #arrays.length(param.brands) > 0 ? param.brands : null},
                           storages=${param.storages != null and #arrays.length(param.storages) > 0 ? param.storages : null},
                           colors=${param.colors != null and #arrays.length(param.colors) > 0 ? param.colors : null},
                           ram=${param.ram != null and #arrays.length(param.ram) > 0 ? param.ram : null},
                           screenSizes=${param.screenSizes != null and #arrays.length(param.screenSizes) > 0 ? param.screenSizes : null},
                           waterResistant=${param.waterResistant != null ? param.waterResistant[0] : null},
                           batteryCapacities=${param.batteryCapacities != null and #arrays.length(param.batteryCapacities) > 0 ? param.batteryCapacities : null},
                           maxPrice=${param.maxPrice != null ? param.maxPrice[0] : null})}"
                       class="filter-remove-link remove-filter">×</a>
                </span>
            </div>
        </div>

        <form id="filterForm" action="/phones" method="get" th:data-max-price="${maxPhonePrice}">
            <div class="mb-4 filter-section">
                <h6>Brand</h6>
                <div>
                    <div class="form-check filter-item" th:each="brand, iterStat : ${brands}">
                        <input class="form-check-input" type="checkbox" th:id="'brand' + ${brand}"
                               th:value="${brand}" name="brands"
                               th:checked="${param.brands != null && #lists.contains(param.brands, brand)}">
                        <label class="form-check-label" th:for="'brand' + ${brand}" th:text="${brand}"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(brands) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Storage</h6>
                <div>
                    <div class="form-check filter-item" th:each="storage, iterStat : ${storages}">
                        <input class="form-check-input" type="checkbox" th:id="'storage' + ${storage}"
                               th:value="${storage}" name="storages"
                               th:checked="${param.storages != null && #lists.contains(param.storages, storage.toString())}">
                        <label class="form-check-label" th:for="'storage' + ${storage}"
                               th:text="${storage} + ' GB'"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(storages) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Color</h6>
                <div>
                    <div class="form-check filter-item" th:each="color, iterStat : ${colors}">
                        <input class="form-check-input" type="checkbox" th:id="'color' + ${color}"
                               th:value="${color}" name="colors"
                               th:checked="${param.colors != null && #lists.contains(param.colors, color)}">
                        <label class="form-check-label" th:for="'color' + ${color}" th:text="${color}"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(colors) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>RAM</h6>
                <div>
                    <div class="form-check filter-item" th:each="ram, iterStat : ${ramOptions}">
                        <input class="form-check-input" type="checkbox" th:id="'ram' + ${ram}"
                               th:value="${ram}" name="ram"
                               th:checked="${param.ram != null && #lists.contains(param.ram, ram.toString())}">
                        <label class="form-check-label" th:for="'ram' + ${ram}"
                               th:text="${ram} + ' GB'"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(ramOptions) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Camera Resolution</h6>
                <div>
                    <div class="form-check filter-item" th:each="resolution, iterStat : ${cameraResolutions}">
                        <input class="form-check-input" type="checkbox" th:id="'resolution' + ${resolution}"
                               th:value="${resolution}" name="cameraResolutions"
                               th:checked="${param.cameraResolutions != null && #lists.contains(param.cameraResolutions, resolution)}">
                        <label class="form-check-label" th:for="'resolution' + ${resolution}"
                               th:text="${resolution} + ' MP'"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(cameraResolutions) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Screen Size</h6>
                <div>
                    <div class="form-check filter-item" th:each="screenSize, iterStat : ${screenSizes}">
                        <input class="form-check-input" type="checkbox" th:id="'screenSize' + ${screenSize}"
                               th:value="${screenSize}" name="screenSizes"
                               th:checked="${param.screenSizes != null && #lists.contains(param.screenSizes, screenSize)}">
                        <label class="form-check-label" th:for="'screenSize' + ${screenSize}" 
                               th:text="${screenSize} + ' inches'"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(screenSizes) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Water Resistance</h6>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="waterResistant"
                               name="waterResistant" value="true"
                               th:checked="${param.waterResistant != null && param.waterResistant[0] == 'true'}"
                               th:disabled="${!hasWaterResistantPhones}">
                        <label class="form-check-label" for="waterResistant">Water Resistant</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 filter-section">
                <h6>Battery Capacity</h6>
                <div>
                    <div class="form-check filter-item" th:each="capacity, iterStat : ${batteryCapacities}">
                        <input class="form-check-input" type="checkbox" th:id="'battery' + ${capacity}"
                               th:value="${capacity}" name="batteryCapacities"
                               th:checked="${param.batteryCapacities != null && #lists.contains(param.batteryCapacities, capacity.toString())}">
                        <label class="form-check-label" th:for="'battery' + ${capacity}" 
                               th:text="${capacity} + ' mAh'"></label>
                    </div>
                    <div class="show-more-container" th:if="${#lists.size(batteryCapacities) > 5}">
                        <a href="#" class="show-more-toggle">Show more</a>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <h6>Special Offers</h6>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="discountedOnly"
                               name="discountedOnly" value="true"
                               th:checked="${param.discountedOnly != null && param.discountedOnly[0] == 'true'}">
                        <label class="form-check-label" for="discountedOnly">
                            <span class="discount-label">On Sale</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="price-range-container">
                <h6>Price Range:</h6>
                <div class="range-slider">
                    <input type="number" class="min-price" th:min="0" th:max="${maxPhonePrice}"
                           th:value="${param.minPrice != null ? param.minPrice[0] : 0}"/>
                    <span>_</span>
                    <input type="number" class="max-price" th:min="0" th:max="${maxPhonePrice}"
                           th:value="${param.maxPrice != null ? param.maxPrice[0] : maxPhonePrice}"/>

                    <div class="range">
                        <input type="range" class="min-input" th:min="0" th:max="${maxPhonePrice}"
                               th:value="${param.minPrice != null ? param.minPrice[0] : 0}" step="1"/>
                        <input type="range" class="max-input" th:min="0" th:max="${maxPhonePrice}"
                               th:value="${param.maxPrice != null ? param.maxPrice[0] : maxPhonePrice}" step="1"/>

                        <div class="slider">
                            <div class="progress"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
        </form>
    </aside>
</div>
